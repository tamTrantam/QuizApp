{% extends 'base.html' %}
{% load static %}

{% block title %}My Quiz Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'quizzes/css/dashboard.css' %}">
<style>
    .dashboard-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .dashboard-header {
        text-align: center;
        margin-bottom: 40px;
        padding: 40px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
    }
    
    .stats-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }
    
    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        border-top: 5px solid #667eea;
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-icon {
        font-size: 3rem;
        margin-bottom: 15px;
    }
    
    .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 10px;
    }
    
    .stat-label {
        color: #666;
        font-weight: 600;
    }
    
    .performance-chart {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin-top: 20px;
    }
    
    .recent-attempts {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .attempt-card {
        border: 1px solid #eee;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
        background: #fafafa;
    }
    
    .attempt-card:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transform: translateX(5px);
    }
    
    .attempt-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .quiz-title {
        font-weight: bold;
        color: #333;
        font-size: 1.1rem;
    }
    
    .attempt-score {
        font-size: 1.3rem;
        font-weight: bold;
        padding: 8px 15px;
        border-radius: 20px;
        color: white;
    }
    
    .score-excellent { background: #4CAF50; }
    .score-good { background: #2196F3; }
    .score-average { background: #FF9800; }
    .score-below-average { background: #FF5722; }
    .score-poor { background: #f44336; }
    
    .attempt-details {
        display: flex;
        justify-content: space-between;
        color: #666;
        font-size: 0.9rem;
    }
    
    .achievements {
        background: white;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .achievement-badge {
        display: inline-block;
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        margin: 5px;
        font-weight: bold;
    }
    
    .performance-comparison {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .comparison-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .best-performance {
        border-top: 5px solid #4CAF50;
    }
    
    .worst-performance {
        border-top: 5px solid #f44336;
    }
    
    .no-data {
        text-align: center;
        padding: 60px;
        color: #666;
    }
    
    .action-button {
        display: inline-block;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 30px;
        border-radius: 25px;
        text-decoration: none;
        font-weight: bold;
        margin: 10px;
        transition: all 0.3s ease;
    }
    
    .action-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        color: white;
        text-decoration: none;
    }
    
    @media (max-width: 768px) {
        .dashboard-container {
            padding: 10px;
        }
        
        .stats-overview {
            grid-template-columns: 1fr;
        }
        
        .performance-comparison {
            grid-template-columns: 1fr;
        }
        
        .attempt-header {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>
{% endblock %}
{% block content %}
<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1>üìä My Quiz Dashboard</h1>
        <p>Track your progress and performance across all quizzes</p>
        <div class="dashboard-welcome">
            <span class="welcome-text">Welcome back, <strong>{{ user.username }}</strong>!</span>
        </div>
    </div>
    
    {% if stats.total_attempts > 0 %}
    <!-- Statistics Overview -->
    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-icon">üìö</div>
            <div class="stat-value">{{ stats.total_quizzes_taken }}</div>
            <div class="stat-label">Quizzes Taken</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">üéØ</div>
            <div class="stat-value">{{ stats.total_attempts }}</div>
            <div class="stat-label">Total Attempts</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">üìà</div>
            <div class="stat-value">{{ stats.avg_score }}%</div>
            <div class="stat-label">Average Score</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">‚≠ê</div>
            <div class="stat-value">
                {% if stats.avg_score >= 90 %}A
                {% elif stats.avg_score >= 80 %}B
                {% elif stats.avg_score >= 70 %}C
                {% elif stats.avg_score >= 60 %}D
                {% else %}F{% endif %}
            </div>
            <div class="stat-label">Overall Grade</div>
        </div>
    </div>
    
    <!-- Performance Comparison -->
    {% if best_attempt and worst_attempt %}
    <div class="performance-comparison">
        <div class="comparison-card best-performance">
            <h3>üèÜ Best Performance</h3>
            <div class="success-rate">
                {{ best_attempt.percentage_score|floatformat:1 }}%
            </div>
            <div><strong>{{ best_attempt.quiz.title }}</strong></div>
            <div class="stat-description">
                {{ best_attempt.completed_at|date:"M d, Y" }}
            </div>
        </div>
        
        {% if best_attempt != worst_attempt %}
        <div class="comparison-card worst-performance">
            <h3>üí™ Room for Improvement</h3>
            <div class="failure-rate">
                {{ worst_attempt.percentage_score|floatformat:1 }}%
            </div>
            <div><strong>{{ worst_attempt.quiz.title }}</strong></div>
            <div class="stat-description">
                {{ worst_attempt.completed_at|date:"M d, Y" }}
            </div>
        </div>
        {% else %}
        <div class="comparison-card">
            <h3>üéØ Consistency</h3>
            <div style="font-size: 1.5rem; margin: 15px 0;">
                Great! Your performance is consistent across attempts.
            </div>
            <div style="color: #666;">
                Keep up the excellent work!
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <!-- Performance Chart -->
    {% if stats.performance_trend %}
    <div class="performance-chart">
        <h3>üìà Performance Trend (Last 10 Attempts)</h3>
        <div class="chart-container">
            <canvas id="performanceChart"></canvas>
        </div>
    </div>
    {% endif %}
    
    <!-- Achievements -->
    <div class="achievements">
        <h3>üèÖ Achievements</h3>
        <div style="margin-top: 20px;">
            {% if stats.total_attempts >= 10 %}
                <span class="achievement-badge">üéØ Quiz Master - 10+ Attempts</span>
            {% endif %}
            
            {% if stats.avg_score >= 90 %}
                <span class="achievement-badge">‚≠ê Perfectionist - 90%+ Average</span>
            {% elif stats.avg_score >= 80 %}
                <span class="achievement-badge">üåü High Achiever - 80%+ Average</span>
            {% endif %}
            
            {% if stats.total_quizzes_taken >= 5 %}
                <span class="achievement-badge">üìö Knowledge Seeker - 5+ Quizzes</span>
            {% endif %}
            
            {% if best_attempt and best_attempt.percentage_score == 100 %}
                <span class="achievement-badge">üíØ Perfect Score</span>
            {% endif %}
            
            {% if not stats.total_attempts %}
                <span style="color: #666; font-style: italic;">Complete your first quiz to earn achievements!</span>
            {% endif %}
        </div>
    </div>
    
    <!-- Recent Attempts -->
    <div class="recent-attempts">
        <h3>üìù Recent Quiz Attempts</h3>
        
        {% for attempt in recent_attempts %}
        <div class="attempt-card">
            <div class="attempt-header">
                <div class="quiz-title">{{ attempt.quiz.title }}</div>
                <div class="attempt-score 
                    {% if attempt.percentage_score >= 90 %}score-excellent
                    {% elif attempt.percentage_score >= 80 %}score-good
                    {% elif attempt.percentage_score >= 70 %}score-average
                    {% elif attempt.percentage_score >= 60 %}score-below-average
                    {% else %}score-poor{% endif %}">
                    {{ attempt.percentage_score|floatformat:1 }}%
                </div>
            </div>
            
            <div class="attempt-details">
                <span>üìÖ {{ attempt.completed_at|date:"M d, Y H:i" }}</span>
                <span>üìä {{ attempt.score }}/{{ attempt.total_questions }} correct</span>
                <span>‚è±Ô∏è Grade: {{ attempt.grade_letter }}</span>
                {% if attempt.time_taken %}
                <span>‚è∞ {{ attempt.time_taken.total_seconds|floatformat:0 }}s</span>
                {% endif %}
            </div>
            
            <div style="margin-top: 15px;">
                <a href="{% url 'quizzes:quiz_results' attempt.quiz.id attempt.id %}" 
                   class="action-button" style="font-size: 0.9rem; padding: 8px 16px;">
                    View Results
                </a>
                <a href="{% url 'quizzes:take_quiz' attempt.quiz.id %}" 
                   class="action-button" style="font-size: 0.9rem; padding: 8px 16px;">
                    Retake Quiz
                </a>
            </div>
        </div>
        {% empty %}
        <div class="no-data">
            <div style="font-size: 3rem; margin-bottom: 20px;">üìö</div>
            <h3>No quiz attempts yet!</h3>
            <p>Start taking quizzes to see your progress here.</p>
        </div>
        {% endfor %}
    </div>
    
    {% else %}
    <!-- No Data State -->
    <div class="no-data">
        <div style="font-size: 5rem; margin-bottom: 20px;">üìä</div>
        <h2>Welcome to Your Quiz Dashboard!</h2>
        <p>You haven't taken any quizzes yet. Start your learning journey now!</p>
        <a href="{% url 'quizzes:quiz_list' %}" class="action-button">
            üöÄ Browse Quizzes
        </a>
    </div>
    {% endif %}
    
    <!-- Action Buttons -->
    <div style="text-align: center; margin-top: 40px;">
        <a href="{% url 'quizzes:quiz_list' %}" class="action-button">
            üìö Browse All Quizzes
        </a>
        {% if recent_attempts %}
        <a href="{% url 'quizzes:take_quiz' recent_attempts.0.quiz.id %}" class="action-button">
            üîÑ Retake Last Quiz
        </a>
        {% endif %}
    </div>
</div>

<!-- Chart.js for Performance Trend -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% if stats.performance_trend %}
    // Performance Trend Chart
    const ctx = document.getElementById('performanceChart').getContext('2d');
    const performanceData = {{ stats.performance_trend|safe }};
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: performanceData.map((_, index) => `Attempt ${performanceData.length - index}`),
            datasets: [{
                label: 'Score (%)',
                data: performanceData.reverse(),
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#667eea',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
    {% endif %}
    
    // Add entrance animations
    const cards = document.querySelectorAll('.stat-card, .attempt-card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, 100 * index);
    });
});
</script>
{% endblock %}